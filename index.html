<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Infinispan Hands-On &mdash; JBoss One Day Talk 2013</title>

    <meta name="description" content="Infinispan Hands-On - JBoss One Day Talk 2013">
    <meta name="author" content="Fabian St&auml;ber">

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/consol.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
        document.write('<link rel="stylesheet" href="css/print/' + ( window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">');
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>

    <![endif]-->
</head>

<body>
<div class="reveal">

<!-- Any section element inside of this container is displayed as a slide -->
<div class="slides">
<section data-background="consol-background-title.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <h1>Infinispan Hands-On</h1>
    Fabian Stäber<p/>
    JBoss OneDayTalk 2013
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <div style="display: inline-block; width: 49%; vertical-align: top;">
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="consol.png"/>
    </div>
    <div style="display: inline-block; width: 49%; vertical-align: top;">
        <h3>About ConSol*</h3>
        <ul>
            <li>Headquarters in Munich
            <li>Since 1984
            <li>More than 200 employees
            <li>In-Memory DMS Consulting Team
        </ul>
    </div>
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <h3>Why is Caching Interesting?</h3>
    <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="why-is-caching-interesting.png"/>
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <h3>Why Infinispan?</h3>
    <ul>
        <li>Easy to use
        <li>Standards compliant (soon)
        <li>Powerful under the hood
    </ul>
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <h3>Content</h3>
    <ul>
        <li>Easy to use
            <ul>
                <li>We will build a full JEE example in 15 minutes
            </ul>
        <li>Standards compliant (soon)
            <ul>
                <li>JCACHE (JSR 107) Intro
            </ul>
        <li>Powerful under the hood
            <ul>
                <li>Dive into Infinispan's distribution mode
            </ul>
    </ul>
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <section>
        <h3>Content</h3>
        <ul>
            <li>Easy to use
                <ul>
                    <li class="active-section">We will build a full JEE example in 15 minutes
                </ul>
            <li>Standards complieat (soon)
                <ul>
                    <li>JCACHE (JSR 107) Intro
                </ul>
            <li>Powerful under the hood
                <ul>
                    <li>Dive into Infinispan's distribution mode
                </ul>
        </ul>
    </section>
    <section>
        <h3>Typical Applications of Infinispan</h3>
        <ul>
            <li>Cache for databases
            <li>Cache for other things
                <ul>
                    <li>Servlet responses
                    <li>Results of expensive computations
                    <li>etc
                </ul>
            <li>NoSQL key/value data store
        </ul>
    </section>
    <section>
        <h3>JEE Application Example</h3>
        <ul>
            <li>JBoss Application Server
            <li>Persistence layer with JPA and Hibernate
            <li>REST interface
        </ul>
    </section>
    <section>
        <h3>What is First and Second Level caching in Hibernate?</h3>
    </section>
    <section>
        <h3>First-level cache</h3>
        Associates with the <b>Session</b> object.
        Reduces the number of SQL queries it needs to generate within a given transaction.
        Hibernate uses this cache by default.
        <br/><br/>
        <h3>Second-level cache</h3>
        Associates with the <b>Session Factory</b> object.
        Scope is the entire application, not just a single transaction.
    </section>
    <section>
        <h3>Real-Live Example in Three Steps</h3>
        <ol>
            <li>Example Project from Maven Archetype
            <li>Enable Database Logging
            <li>Enabling Infinispan L2 Cache
        </ol>
    </section>
    <section>
        <h3>Maven Archetype</h3>
                                    <pre>
<code>
    mvn archetype:generate \
    -DarchetypeArtifactId=jboss-javaee6-webapp-archetype \
    -DarchetypeGroupId=org.jboss.spec.archetypes \
    -DarchetypeVersion=7.1.2.Final \
    -DgroupId=de.consol.research \
    -DartifactId=infinispan-jpa-example \
    -Dversion=1.0-SNAPSHOT \
    -Dname="Infinispan JPA Example" \
    -DarchetypeCatalog=http://search.maven.org/remotecontent?filepath=archetype-catalog.xml \
    -DinteractiveMode=false

    cd infinispan-jpa-example
    mvn clean verify jboss-as:run
</code>
</pre>
    </section>
    <section>
        <h3>Example Application</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="example-application.png"/>
    </section>
    <section>
        <h3>Example Application</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="example-application-rest-interface.png"/>
    </section>
    <section>
        <h3>Enable Database Logging</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="edit-import-sql.png"/>
<pre>
<code>
    SET TRACE_LEVEL_SYSTEM_OUT 2;
</code>
</pre>
    </section>
    <section>
        <h3>Enable 2nd Level Cache</h3>
        In <code>persistence.xml</code>:
<pre>
<code>
    &lt;shared-cache-mode&gt;DISABLE_SELECTIVE&lt;/shared-cache-mode&gt;
    &lt;properties&gt;
    &lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
    &lt;/properties&gt;
</code>
</pre>
    </section>
    <section>
        <h3>Cache Modes</h3>
        <table class="small" border="1">
            <tr>
                <td><code>ALL</code></td>
                <td>All entity data is stored in the second-level cache for this persistence unit.</td>
            </tr>
            <tr>
                <td><code>NONE</code></td>
                <td>No data is cached in the persistence unit. The persistence provider must not cache any data.</td>
            </tr>
            <tr>
                <td style="padding-right: 1em"><code>ENABLE_SELECTIVE</code></td>
                <td>Enable caching for entities that have been explicitly set with the <code>@Cacheable</code>
                    annotation.
                </td>
            </tr>
            <tr>
                <td style="padding-right: 1em"><code>DISABLE_SELECTIVE</code></td>
                <td>Enable caching for all entities except those that have been explicitly set with the <code>@Cacheable(false)</code>
                    annotation.
                </td>
            </tr>
            <tr>
                <td><code>UNSPECIFIED</code></td>
                <td>The caching behavior for the persistence unit is undefined. The persistence provider's default
                    caching behavior will be used.
                </td>
            </tr>
        </table>
    </section>
    <section>
        <h3>JBoss Management Console</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="jboss-management-console.png"/>
    </section>
    <section>
        <h3>Infinispan's Clustering Modes</h3>
        <ul>
            <li>Invalidation: cluster-aware "local" caches that are able to invalidate entries if entries are modified
                elsewhere in the cluster.
            <li>Replicated cache: Fully Replicated.
            <li>Distributed cache: Consistent Hash.
            <li>Additional (not on JBoss AS managment console): Client-Server mode
        </ul>
    </section>
    <section>
        <h3>Replication Mode</h3>

        <div style="display: inline-block; width: 49%; vertical-align: top;">
            <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="replication-mode.png"/>
        </div>
        <div style="display: inline-block; width: 49%; vertical-align: top;">
            <ul>
                <li>Read operations served from local node
                <li>Write operations broadcast to each node
                <li>Expensive to implement atomic operations
            </ul>
        </div>
    </section>
    <section>
        <h3>Distribution Mode</h3>
        <ul>
            <li>Read often served from remote node
            <li>Writes sent to defined set of nodes
            <li>Inexpensive to implement atomic operations
            <li>Different strategies with joining andeaving nodes.
        </ul>
        <img style="padding-top: 1em; background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="distribution-mode.png"/>
    </section>
    <section>
        <h3>Client-Server Mode</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="client-server-mode.png"/>
    </section>
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <section>
        <h3>Content</h3>
        <ul>
            <li>Easy to use
                <ul>
                    <li>We will build a full JEE example in 15 minutes
                </ul>
            <li>Standards compliant (soon)
                <ul>
                    <li class="active-section">JCACHE (JSR 107) Intro
                </ul>
            <li>Powerful under the hood
                <ul>
                    <li>Dive into Infinispan's distribution mode
                </ul>
        </ul>
    </section>
    <section>
        <h3>JCACHE - JSR 107</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="jsr107.png"/>
    </section>
    <section>
        <h3>JSR 107 Core Interfaces</h3>
        <ul>
            <li><span class="code">CachingProvider:</span> Configure CacheManagers
            <li><span class="code">CacheManager:</span> Acquire Cache
            <li><span class="code">Cache:</span> ConcurrentMap + eviction + backed by distributied topology
            <li><span class="code">Entry:</span> Key-value pair
            <li><span class="code">Expiry</span>
        </ul>
    </section>
    <section>
        <h3>JSR 107 Timetable 2013</h3>
        <center>
        <table class="small" border="1">
            <tr class="head">
                <th>Deliverable</th><th>Start</th><th>Finish</th>
            </tr>
            <tr>
                <td>Public Review Ballot</td><td>27 Aug</td><td>9 Sep</td>
            </tr>
            <tr>
                <td>Proposed Final Draft</td><td>&nbsp;</td><td>30 Sep</td>
            </tr>
            <tr>
                <td>Reference Implementation (<a href="https://github.com/jsr107/RI">https://github.com/jsr107/RI</a>),<br/>Technology Compatibility Kit</td><td>&nbsp;</td><td>31 Oct</td>
            </tr>
            <tr>
                <td>Appeal Ballot (7 days)</td><td>31 Oct</td><td>7 Nov</td>
            </tr>
            <tr>
                <td>Final Approval Ballot</td><td>14 Nov</td><td>28 Nov</td>
            </tr>
            <tr>
                <td>Final Release </td><td>28 Nov</td><td>12 Dec</td>
            </tr>
        </table>
        <small>Source: JavaOne 2013</small>
        </center>
    </section>
    <section>
        <h3>Concurrent Map</h3>
        The following code is not thread safe
<pre>
<code>
private Cache&lt;String, Integer&gt; cache;

public void incrementUnsafe(String user) {
    if ( ! cache.containsKey(user) ) {
        cache.put(user, 0);
    }
    int current = cache.get(user);
    cache.put("user", current + 1);
}
</code>
</pre>
    </section>
    <section>
        <h3>Concurrent Map</h3>
        Synchronized only works within single VM.
<pre>
<code>
private Cache&lt;String, Integer&gt; cache;

public synchronized void incrementThreadSafe(String user) {
    if ( ! cache.containsKey(user) ) {
        cache.put(user, 0);
    }
    int current = cache.get(user);
    cache.put("user", current + 1);
}
</code>
</pre>
    </section>
    <section>
        <h3>Concurrent Map</h3>
        Atomic Compare and Swap
        <img style="position: absolute; z-index: 1; background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="requires-sync.png"/>
<pre>
<code>
private Cache&lt;String, Integer&gt; cache;

public void incrementAtomic(String user) {
    cache.putIfAbsent(user, 0);
    int current;
    do {
        current = cache.get(user);
    }
    while (!cache.replace(user, current, current + 1));
}
</code>
</pre>
    </section>
    <section>
        <h3>Concurrent Map</h3>
        CAS operations can be understood<br/>
        as an optimistic locking approach.<p/>
        Alternatively, caches provide<br/>
        pessimistic lock / mutate / unlock.
    </section>
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <section>
        <h3>Content</h3>
        <ul>
            <li>Easy to use
                <ul>
                    <li>We will build a full JEE example in 15 minutes
                </ul>
            <li>Standards compliant (soon)
                <ul>
                    <li>JCACHE (JSR 107) Intro
                </ul>
            <li>Powerful under the hood
                <ul>
                    <li class="active-section">Dive into Infinispan's distribution mode
                </ul>
        </ul>
    </section>
    <section>
        <h3>Simple Distributed Hash</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="distributed-hash-simple.png"/>
    </section>
    <section>
        <h3>Distributed Hash with Back-up on "Neighbor to the Right"</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="distributed-hash-with-backup-on-neighbor.png"/>
    </section>
    <section>
        <h3>Distributed Hash with Back-up on "Neighbor to the Right"</h3>
        Problem:
        <ul>
            <li>Immediatly after Node failure: Back-up node may become overloaded, because gets all keys from failing neighbor.
            <li>Rebalance: Nearly all keys need to be remapped when # nodes decreases / increases.
        </ul>
    </section>
    <section>
        <h3>Distributed Hash with Secondary Back-up Hash</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="distributed-hash-with-backup-hash.png"/>
    </section>
    <section>
        <h3>Distributed Hash with Secondary Back-up Hash</h3>
        Problem:
        <ul>
            <li><del>Immediatly after Node failure: Back-up node may become overloaded, because gets all keys from failing neighbor.</del>
            <li>Rebalance: Nearly all keys need to be remapped when # nodes decreases / increases.
        </ul>
    </section>
    <section>
        <h3>Consistent Hashing</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="consistent-hash.png"/>
    </section>
    <section>
        <h3>Consistent Hashing</h3>
        <ul>
        <li>On Node Failure: Load is distributed on #segments / #nodes nodes.
        <li>Rebalance: Only #segments / #nodes segments need to be remapped.
        </ul>
        Notes:
        <ul>
        <li>Default Num Segments for Infinispan is 60
        <li>It does not make sense to configure num segments < num nodes, because then nodes will be empty.
        </li>
        </ul>
    </section>
    <section data-background="consol-background-demo.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
        <h3>Demo</h3>
        <small><a href="infinispan-consistent-hash-visualization/index.html">infinispan-consistent-hash-visualization/index.html</a></small>
    </section>
    <section>
        <h3>Demo</h3>
        <img style="background: rgba(255, 255, 255, 0); border: 0; box-shadow: 0 0 0 0" src="distribution-mode-visualization-demo.png"/>
    </section>
    <section>
        <h3>Demo</h3>
        <ul>
        <li>Num Keys: 600, Num Segments: 6.
        <li>Keys per segment: ca 100
        <li>Num Nodes 6: Everything evenly distributed (100 primary keys per Node)
        <li>Num Nodes 5: One node has about 200 primary keys, the others have 100 primary keys.
        <li>Num Nodes: 7: One node does not have any primary keys, the others have 100 primary keys.
        </ul>
    </section>
</section>
<section data-background="consol-background.jpg" data-background-size="100% 100%" data-background-color="#FFFFFF">
    <h3>Summary</h3>
    Infinispan is...
    <p/>
    <ul>
        <li>Easy to use
        <li>Standards compliant (soon)
        <li>Powerful under the hood
    </ul>
</section>

</div>

</div>

<footer style="display:none;">
    <div style="float:left; color: white">JBoss One Day Talk 2013 &mdash; ConSol* Consulting & Solutions Software GmbH</div>
</footer>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.min.js"></script>

<script>

    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
            { src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            } },
            { src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            } },
            { src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            } },
            { src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                hljs.initHighlightingOnLoad();
            } },
            { src: 'plugin/zoom-js/zoom.js', async: true, condition: function () {
                return !!document.body.classList;
            } },
            { src: 'plugin/notes/notes.js', async: true, condition: function () {
                return !!document.body.classList;
            } },
            { src: 'gist5355231-f4c38201054020beae39e0d481e139321eb5d477/footer.reveal.js', condition: function () {
                return !!document.querySelector('footer');
            } }
        ]
    });

</script>

</body>
</html>
